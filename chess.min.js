/* @license
 * Copyright (c) 2018, Jeff Hlywa (jhlywa@gmail.com)
 * Released under the BSD license
 * https://github.com/jhlywa/chess.js/blob/master/LICENSE
 */
var Chess=function(r){var e="b",n="w",t=-1,o="p",i="n",f="b",a="r",l="q",u="k",s="pnbrqkPNBRQK",p="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",c=["1-0","0-1","1/2-1/2","*"],v={b:[16,32,17,15],w:[-16,-32,-17,-15]},g={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},h=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],E=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],d={p:0,n:1,b:2,r:3,q:4,k:5},b={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},C={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},S=7,A=6,m=1,y=0,T={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},N={w:[{square:T.a1,flag:C.QSIDE_CASTLE},{square:T.h1,flag:C.KSIDE_CASTLE}],b:[{square:T.a8,flag:C.QSIDE_CASTLE},{square:T.h8,flag:C.KSIDE_CASTLE}]},I=new Array(128),P={w:t,b:t},R=n,L={w:0,b:0},_=t,w=0,O=1,k=[],q={};function D(r){void 0===r&&(r=!1),I=new Array(128),P={w:t,b:t},R=n,L={w:0,b:0},_=t,w=0,O=1,k=[],r||(q={}),B(x())}function K(){Q(p)}function Q(r,o){void 0===o&&(o=!1);var i,f=r.split(/\s+/),a=f[0],l=0;if(!U(r).valid)return!1;D(o);for(var u=0;u<a.length;u++){var s=a.charAt(u);if("/"===s)l+=8;else if(i=s,-1!=="0123456789".indexOf(i))l+=parseInt(s,10);else{var p=s<"a"?n:e;$({type:s.toLowerCase(),color:p},fr(l)),l++}}return R=f[1],f[2].indexOf("K")>-1&&(L.w|=C.KSIDE_CASTLE),f[2].indexOf("Q")>-1&&(L.w|=C.QSIDE_CASTLE),f[2].indexOf("k")>-1&&(L.b|=C.KSIDE_CASTLE),f[2].indexOf("q")>-1&&(L.b|=C.QSIDE_CASTLE),_="-"===f[3]?t:T[f[3]],w=parseInt(f[4],10),O=parseInt(f[5],10),B(x()),!0}function U(r){var e="No errors.",n="FEN string must contain six space-delimited fields.",t="6th field (move number) must be a positive integer.",o="5th field (half move counter) must be a non-negative integer.",i="4th field (en-passant square) is invalid.",f="3rd field (castling availability) is invalid.",a="2nd field (side to move) is invalid.",l="1st field (piece positions) does not contain 8 '/'-delimited rows.",u="1st field (piece positions) is invalid [consecutive numbers].",s="1st field (piece positions) is invalid [invalid piece].",p="1st field (piece positions) is invalid [row too large].",c="Illegal en-passant square",v=r.split(/\s+/);if(6!==v.length)return{valid:!1,errorNumber:1,error:n};if(isNaN(v[5])||parseInt(v[5],10)<=0)return{valid:!1,errorNumber:2,error:t};if(isNaN(v[4])||parseInt(v[4],10)<0)return{valid:!1,errorNumber:3,error:o};if(!/^(-|[abcdefgh][36])$/.test(v[3]))return{valid:!1,errorNumber:4,error:i};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(v[2]))return{valid:!1,errorNumber:5,error:f};if(!/^(w|b)$/.test(v[1]))return{valid:!1,errorNumber:6,error:a};var g=v[0].split("/");if(8!==g.length)return{valid:!1,errorNumber:7,error:l};for(var h=0;h<g.length;h++){for(var E=0,d=!1,b=0;b<g[h].length;b++)if(isNaN(g[h][b])){if(!/^[prnbqkPRNBQK]$/.test(g[h][b]))return{valid:!1,errorNumber:9,error:s};E+=1,d=!1}else{if(d)return{valid:!1,errorNumber:8,error:u};E+=parseInt(g[h][b],10),d=!0}if(8!==E)return{valid:!1,errorNumber:10,error:p}}return"3"==v[3][1]&&"w"==v[1]||"6"==v[3][1]&&"b"==v[1]?{valid:!1,errorNumber:11,error:c}:{valid:!0,errorNumber:0,error:e}}function x(){for(var r=0,o="",i=T.a8;i<=T.h1;i++){if(null==I[i])r++;else{r>0&&(o+=r,r=0);var f=I[i].color,a=I[i].type;o+=f===n?a.toUpperCase():a.toLowerCase()}i+1&136&&(r>0&&(o+=r),i!==T.h1&&(o+="/"),r=0,i+=8)}var l="";L[n]&C.KSIDE_CASTLE&&(l+="K"),L[n]&C.QSIDE_CASTLE&&(l+="Q"),L[e]&C.KSIDE_CASTLE&&(l+="k"),L[e]&C.QSIDE_CASTLE&&(l+="q"),l=l||"-";var u=_===t?"-":fr(_);return[o,R,l,u,w,O].join(" ")}function j(r){for(var e=0;e<r.length;e+=2)"string"==typeof r[e]&&"string"==typeof r[e+1]&&(q[r[e]]=r[e+1]);return q}function B(r){k.length>0||(r!==p?(q.SetUp="1",q.FEN=r):(delete q.SetUp,delete q.FEN))}function M(r){var e=I[T[r]];return e?{type:e.type,color:e.color}:null}function $(r,e){if(!("type"in r&&"color"in r))return!1;if(-1===s.indexOf(r.type.toLowerCase()))return!1;if(!(e in T))return!1;var n=T[e];return(r.type!=u||P[r.color]==t||P[r.color]==n)&&(I[n]={type:r.type,color:r.color},r.type===u&&(P[r.color]=n),B(x()),!0)}function W(r,e,n,t,i){var f={color:R,from:e,to:n,flags:t,piece:r[e].type};return i&&(f.flags|=C.PROMOTION,f.promotion=i),r[n]?f.captured=r[n].type:t&C.EP_CAPTURE&&(f.captured=o),f}function F(r){function e(r,e,n,t,u){if(r[n].type!==o||or(t)!==y&&or(t)!==S)e.push(W(r,n,t,u));else for(var s=[l,a,f,i],p=0,c=s.length;p<c;p++)e.push(W(r,n,t,u,s[p]))}var n=[],t=R,u=ar(t),s={b:m,w:A},p=T.a8,c=T.h1,h=!1,E=!(void 0!==r&&"legal"in r)||r.legal;if(void 0!==r&&"square"in r){if(!(r.square in T))return[];p=c=T[r.square],h=!0}for(var d=p;d<=c;d++)if(136&d)d+=7;else{var b=I[d];if(null!=b&&b.color===t)if(b.type===o){var N=d+v[t][0];if(null==I[N]){e(I,n,d,N,C.NORMAL);N=d+v[t][1];s[t]===or(d)&&null==I[N]&&e(I,n,d,N,C.BIG_PAWN)}for(w=2;w<4;w++){136&(N=d+v[t][w])||(null!=I[N]&&I[N].color===u?e(I,n,d,N,C.CAPTURE):N===_&&e(I,n,d,_,C.EP_CAPTURE))}}else for(var w=0,O=g[b.type].length;w<O;w++){var k=g[b.type][w];for(N=d;!(136&(N+=k));){if(null!=I[N]){if(I[N].color===t)break;e(I,n,d,N,C.CAPTURE);break}if(e(I,n,d,N,C.NORMAL),"n"===b.type||"k"===b.type)break}}}if(!h||c===P[t]){if(L[t]&C.KSIDE_CASTLE){var q=(D=P[t])+2;null!=I[D+1]||null!=I[q]||Z(u,P[t])||Z(u,D+1)||Z(u,q)||e(I,n,P[t],q,C.KSIDE_CASTLE)}if(L[t]&C.QSIDE_CASTLE){var D;q=(D=P[t])-2;null!=I[D-1]||null!=I[D-2]||null!=I[D-3]||Z(u,P[t])||Z(u,D-1)||Z(u,q)||e(I,n,P[t],q,C.QSIDE_CASTLE)}}if(!E)return n;var K=[];for(d=0,O=n.length;d<O;d++)er(n[d]),z(t)||K.push(n[d]),nr();return K}function G(r,e){var n="";if(r.flags&C.KSIDE_CASTLE)n="O-O";else if(r.flags&C.QSIDE_CASTLE)n="O-O-O";else{var t=function(r,e){for(var n=F({legal:!e}),t=r.from,o=r.to,i=r.piece,f=0,a=0,l=0,u=0,s=n.length;u<s;u++){var p=n[u].from,c=n[u].to,v=n[u].piece;i===v&&t!==p&&o===c&&(f++,or(t)===or(p)&&a++,ir(t)===ir(p)&&l++)}if(f>0)return a>0&&l>0?fr(t):l>0?fr(t).charAt(1):fr(t).charAt(0);return""}(r,e);r.piece!==o&&(n+=r.piece.toUpperCase()+t),r.flags&(C.CAPTURE|C.EP_CAPTURE)&&(r.piece===o&&(n+=fr(r.from)[0]),n+="x"),n+=fr(r.to),r.flags&C.PROMOTION&&(n+="="+r.promotion.toUpperCase())}return er(r),J()&&(V()?n+="#":n+="+"),nr(),n}function H(r){return r.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function Z(r,t){for(var i=T.a8;i<=T.h1;i++)if(136&i)i+=7;else if(null!=I[i]&&I[i].color===r){var f=I[i],a=i-t,l=a+119;if(h[l]&1<<d[f.type]){if(f.type===o){if(a>0){if(f.color===n)return!0}else if(f.color===e)return!0;continue}if("n"===f.type||"k"===f.type)return!0;for(var u=E[l],s=i+u,p=!1;s!==t;){if(null!=I[s]){p=!0;break}s+=u}if(!p)return!0}}return!1}function z(r){return Z(ar(r),P[r])}function J(){return z(R)}function V(){return J()&&0===F().length}function X(){return!J()&&0===F().length}function Y(){for(var r={},e=[],n=0,t=0,o=T.a8;o<=T.h1;o++)if(t=(t+1)%2,136&o)o+=7;else{var a=I[o];a&&(r[a.type]=a.type in r?r[a.type]+1:1,a.type===f&&e.push(t),n++)}if(2===n)return!0;if(3===n&&(1===r[f]||1===r[i]))return!0;if(n===r[f]+2){var l=0,u=e.length;for(o=0;o<u;o++)l+=e[o];if(0===l||l===u)return!0}return!1}function rr(){for(var r=[],e={},n=!1;;){var t=nr();if(!t)break;r.push(t)}for(;;){var o=x().split(" ").slice(0,4).join(" ");if(e[o]=o in e?e[o]+1:1,e[o]>=3&&(n=!0),!r.length)break;er(r.pop())}return n}function er(r){var n,i=R,f=ar(i);if(n=r,k.push({move:n,kings:{b:P.b,w:P.w},turn:R,castling:{b:L.b,w:L.w},epSquare:_,halfMoves:w,moveNumber:O}),I[r.to]=I[r.from],I[r.from]=null,r.flags&C.EP_CAPTURE&&(R===e?I[r.to-16]=null:I[r.to+16]=null),r.flags&C.PROMOTION&&(I[r.to]={type:r.promotion,color:i}),I[r.to].type===u){if(P[I[r.to].color]=r.to,r.flags&C.KSIDE_CASTLE){var a=r.to-1,l=r.to+1;I[a]=I[l],I[l]=null}else if(r.flags&C.QSIDE_CASTLE){a=r.to+1,l=r.to-2;I[a]=I[l],I[l]=null}L[i]=""}if(L[i])for(var s=0,p=N[i].length;s<p;s++)if(r.from===N[i][s].square&&L[i]&N[i][s].flag){L[i]^=N[i][s].flag;break}if(L[f])for(s=0,p=N[f].length;s<p;s++)if(r.to===N[f][s].square&&L[f]&N[f][s].flag){L[f]^=N[f][s].flag;break}_=r.flags&C.BIG_PAWN?"b"===R?r.to-16:r.to+16:t,r.piece===o?w=0:r.flags&(C.CAPTURE|C.EP_CAPTURE)?w=0:w++,R===e&&O++,R=ar(R)}function nr(){var r=k.pop();if(null==r)return null;var n=r.move;P=r.kings,R=r.turn,L=r.castling,_=r.epSquare,w=r.halfMoves,O=r.moveNumber;var t,i,f=R,a=ar(R);if(I[n.from]=I[n.to],I[n.from].type=n.piece,I[n.to]=null,n.flags&C.CAPTURE)I[n.to]={type:n.captured,color:a};else if(n.flags&C.EP_CAPTURE){var l;l=f===e?n.to-16:n.to+16,I[l]={type:o,color:a}}n.flags&(C.KSIDE_CASTLE|C.QSIDE_CASTLE)&&(n.flags&C.KSIDE_CASTLE?(t=n.to+1,i=n.to-1):n.flags&C.QSIDE_CASTLE&&(t=n.to-2,i=n.to+1),I[t]=I[i],I[i]=null);return n}function tr(r,e){var n=H(r);if(e){var t=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(t)var o=t[1],i=t[2],f=t[3],a=t[4]}for(var l=F(),u=0,s=l.length;u<s;u++){if(n===H(G(l[u]))||e&&n===H(G(l[u],!0)))return l[u];if(t&&(!o||o.toLowerCase()==l[u].piece)&&T[i]==l[u].from&&T[f]==l[u].to&&(!a||a.toLowerCase()==l[u].promotion))return l[u]}return null}function or(r){return r>>4}function ir(r){return 15&r}function fr(r){var e=ir(r),n=or(r);return"abcdefgh".substring(e,e+1)+"87654321".substring(n,n+1)}function ar(r){return r===n?e:n}function lr(r){var e=function r(e){var n=e instanceof Array?[]:{};for(var t in e)n[t]="object"==typeof t?r(e[t]):e[t];return n}(r);e.san=G(e,!1),e.to=fr(e.to),e.from=fr(e.from);var n="";for(var t in C)C[t]&e.flags&&(n+=b[t]);return e.flags=n,e}function ur(r){return r.replace(/^\s+|\s+$/g,"")}return Q(void 0===r?p:r),{WHITE:n,BLACK:e,PAWN:o,KNIGHT:i,BISHOP:f,ROOK:a,QUEEN:l,KING:u,SQUARES:function(){for(var r=[],e=T.a8;e<=T.h1;e++)136&e?e+=7:r.push(fr(e));return r}(),FLAGS:b,load:function(r){return Q(r)},reset:function(){return K()},moves:function(r){for(var e=F(r),n=[],t=0,o=e.length;t<o;t++)void 0!==r&&"verbose"in r&&r.verbose?n.push(lr(e[t])):n.push(G(e[t],!1));return n},inCheck:function(){return J()},inCheckmate:function(){return V()},inStalemate:function(){return X()},inDraw:function(){return w>=100||X()||Y()||rr()},insufficientMaterial:function(){return Y()},inThreefoldRepetition:function(){return rr()},gameOver:function(){return w>=100||V()||X()||Y()||rr()},validateFen:function(r){return U(r)},fen:function(){return x()},board:function(){for(var r=[],e=[],n=T.a8;n<=T.h1;n++)null==I[n]?e.push(null):e.push({type:I[n].type,color:I[n].color}),n+1&136&&(r.push(e),e=[],n+=8);return r},pgn:function(r){var e="object"==typeof r&&"string"==typeof r.newlineChar?r.newlineChar:"\n",n="object"==typeof r&&"number"==typeof r.maxWidth?r.maxWidth:0,t=[],o=!1;for(var i in q)t.push("["+i+' "'+q[i]+'"]'+e),o=!0;o&&k.length&&t.push(e);for(var f=[];k.length>0;)f.push(nr());for(var a=[],l="";f.length>0;){var u=f.pop();k.length||"b"!==u.color?"w"===u.color&&(l.length&&a.push(l),l=O+"."):l=O+". ...",l=l+" "+G(u,!1),er(u)}if(l.length&&a.push(l),void 0!==q.Result&&a.push(q.Result),0===n)return t.join("")+a.join(" ");var s=0;for(i=0;i<a.length;i++)s+a[i].length>n&&0!==i?(" "===t[t.length-1]&&t.pop(),t.push(e),s=0):0!==i&&(t.push(" "),s++),t.push(a[i]),s+=a[i].length;return t.join("")},loadPgn:function(r,e){var n=void 0!==e&&"sloppy"in e&&e.sloppy;function t(r){return r.replace(/\\/g,"\\")}var o="object"==typeof e&&"string"==typeof e.newlineChar?e.newlineChar:"\r?\n",i=new RegExp("^(\\[((?:"+t(o)+")|.)*\\])(?:"+t(o)+"){2}"),f=i.test(r)?i.exec(r)[1]:"";K();var a=function(r,e){for(var n="object"==typeof e&&"string"==typeof e.newlineChar?e.newlineChar:"\r?\n",o={},i=r.split(new RegExp(t(n))),f="",a="",l=0;l<i.length;l++)f=i[l].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),a=i[l].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),ur(f).length>0&&(o[f]=a);return o}(f,e);for(var l in a)j([l,a[l]]);if("1"===a.SetUp&&!("FEN"in a&&Q(a.FEN,!0)))return!1;var u=r.replace(f,"").replace(new RegExp(t(o),"g")," ");u=u.replace(/(\{[^}]+\})+?/g,"");for(var s=/(\([^\(\)]+\))+?/g;s.test(u);)u=u.replace(s,"");var p=ur(u=(u=(u=u.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));p=p.join(",").replace(/,,+/g,",").split(",");for(var v="",g=0;g<p.length-1;g++){if(null==(v=tr(p[g],n)))return!1;er(v)}if(v=p[p.length-1],c.indexOf(v)>-1)(function(r){for(var e in r)return!0;return!1})(q)&&void 0===q.Result&&j(["Result",v]);else{if(null==(v=tr(v,n)))return!1;er(v)}return!0},header:function(){return j(arguments)},ascii:function(){return function(){for(var r="   +------------------------+\n",e=T.a8;e<=T.h1;e++){if(0===ir(e)&&(r+=" "+"87654321"[or(e)]+" |"),null==I[e])r+=" . ";else{var t=I[e].type;r+=" "+(I[e].color===n?t.toUpperCase():t.toLowerCase())+" "}e+1&136&&(r+="|\n",e+=8)}return r+="   +------------------------+\n",r+="     a  b  c  d  e  f  g  h\n"}()},turn:function(){return R},move:function(r,e){var n=void 0!==e&&"sloppy"in e&&e.sloppy,t=null;if("string"==typeof r)t=tr(r,n);else if("object"==typeof r)for(var o=F(),i=0,f=o.length;i<f;i++)if(!(r.from!==fr(o[i].from)||r.to!==fr(o[i].to)||"promotion"in o[i]&&r.promotion!==o[i].promotion)){t=o[i];break}if(!t)return null;var a=lr(t);return er(t),a},undo:function(){var r=nr();return r?lr(r):null},clear:function(){return D()},put:function(r,e){return $(r,e)},get:function(r){return M(r)},remove:function(r){return n=M(e=r),I[T[e]]=null,n&&n.type===u&&(P[n.color]=t),B(x()),n;var e,n},perft:function(r){return function r(e){for(var n=F({legal:!1}),t=0,o=R,i=0,f=n.length;i<f;i++)er(n[i]),z(o)||(e-1>0?t+=r(e-1):t++),nr();return t}(r)},squareColor:function(r){if(r in T){var e=T[r];return(or(e)+ir(e))%2==0?"light":"dark"}return null},history:function(r){for(var e=[],n=[],t=(void 0!==r&&"verbose"in r&&r.verbose);k.length>0;)e.push(nr());for(;e.length>0;){var o=e.pop();t?n.push(lr(o)):n.push(G(o)),er(o)}return n}}};"undefined"!=typeof exports&&(exports.Chess=Chess),"undefined"!=typeof define&&define(function(){return Chess});
